<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>People and Places We've Prayed For</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="prayedcontent">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <h1>People and Places We've Prayed For</h1>
        <div class="links">
            <a href="/">Back to Main</a>
            <a href="/queue">View Queue</a>
            <a href="#" id="toggleAffiliationButton" onclick="togglePartyAffiliation()">Show Party Affiliation</a>
			<a href="/statistics">View Statistics</a>
        </div>
        <div class="prayed-list">
            {% for item in prayed_for %}
            <div class="prayed-item">
                <span>
                    <span class="highlight {{ item.party_class }}" data-party-color="{{ item.party_color }}" title="{{ item.party_name }}">{{ item.person_name }}</span>
                    and
                    {{ item.post_label }}
                    were prayed for {{ item.formatted_timestamp }}
                </span>
                <button onclick="returnToQueue('{{ item.person_name }}', '{{ item.post_label }}')">Return to Queue</button>
            </div>
            {% endfor %}
        </div>
        <div class="links">
            <a href="/">Back to Main</a>
            <a href="/queue">View Queue</a>
            <a href="#" id="toggleAffiliationButton" onclick="togglePartyAffiliation()">Show Party Affiliation</a>
			<a href="/statistics">View Statistics</a>
        </div>
    </div>
    <script>
        async function returnToQueue(personName, postLabel) {
            try {
                const formData = new FormData();
                formData.append('person_name', personName);
                formData.append('post_label', postLabel);

                const response = await fetch('/put_back', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to return to queue.');
                }
            } catch (error) {
                console.error('Error returning to queue:', error);
            }
        }

        function togglePartyAffiliation() {
            const highlights = document.querySelectorAll('.highlight');
            let affiliationsVisible = false; // Assume hidden initially
            highlights.forEach(span => {
                if (span.style.backgroundColor === '' || span.style.backgroundColor === 'transparent') {
                    span.style.backgroundColor = span.getAttribute('data-party-color');
                    affiliationsVisible = true; // At least one became visible
                } else {
                    span.style.backgroundColor = 'transparent';
                    // If any are made transparent, the overall state is hidden, unless another is visible.
                    // This simple check might need refinement if spans can have mixed states initially.
                    // For now, if we make one transparent, we assume the goal was to hide.
                }
            });

            // Update button text based on the determined state after changes
            // A more robust way would be to check the state of the *first* element or a specific one.
            // If any span is colored, we assume "Hide" should be the next action.
            const buttons = document.querySelectorAll('[onclick="togglePartyAffiliation()"]');
            let currentAffiliationIsVisible = false;
            if (highlights.length > 0 && highlights[0].style.backgroundColor !== 'transparent' && highlights[0].style.backgroundColor !== '') {
                currentAffiliationIsVisible = true;
            }

            buttons.forEach(button => {
                if (currentAffiliationIsVisible) {
                    button.textContent = 'Hide Party Affiliation';
                } else {
                    button.textContent = 'Show Party Affiliation';
                }
            });
        }

        // Initial setting to hide party affiliation and set button text
        window.onload = function() {
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(span => {
                span.style.backgroundColor = 'transparent';
            });
            // Set initial button text
            const buttons = document.querySelectorAll('[onclick="togglePartyAffiliation()"]');
            buttons.forEach(button => {
                button.textContent = 'Show Party Affiliation';
            });
        }
    </script>
</body>
</html>
